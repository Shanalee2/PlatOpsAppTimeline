<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Timeline Creator</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background-color: #F0F8FF;
      margin: 0;
      padding: 0;
    }
    .container {
      margin: 20px;
      font-size: 80%;
    }
    label {
      font-weight: bold;
      color: #2E8B57;
      margin-top: 10px;
    }
    select, input, button {
      width: 100%;
      padding: 10px;
      margin: 5px 0 15px 0;
      font-size: 14px;
    }
    .timeline-box {
      width: 100%;
      height: 200px;
      background-color: #F5F5F5;
      padding: 10px;
      border: 1px solid #ccc;
      overflow-y: auto;
    }
    button {
      font-weight: bold;
      color: white;
      border: none;
    }
    .add-button {
      background-color: #4682B4;
    }
    .delete-button {
      background-color: #FF4500;
    }
    .copy-button {
      background-color: #FFA500;
    }
    .save-button {
      background-color: #32CD32;
    }
    .crud-container {
      display: flex;
      justify-content: space-between;
      margin-top: 15px;
    }
    .crud-container button {
      width: 48%;
    }
    .timezone-container {
      display: flex;
      align-items: center;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>Timeline Creator</h1>

    <!-- Activity Type Selection -->
    <label for="activity-type">Activity Type:</label>
    <select id="activity-type">
      <option value="AKS Upgrade">AKS Upgrade</option>
      <option value="Istio Upgrade">Istio Upgrade</option>
      <option value="Config Server (RCS) Upgrade">Config Server (RCS) Upgrade</option>
      <option value="HBT Upgrade">HBT Upgrade</option>
      <option value="Certificate Renewal Istio Ingress Gateway">Certificate Renewal Istio Ingress Gateway</option>
      <option value="Certificate renewal for APIM">Certificate renewal for APIM</option>
    </select>

    <!-- Canned Text Selection -->
    <label for="canned-text">Select Canned Text:</label>
    <select id="canned-text">
      <!-- Dynamic canned text will be loaded based on Activity Type -->
    </select>

    <!-- Timezone Selection -->
    <label for="timezone">Select Timezone:</label>
    <select id="timezone">
      <option value="HKT">Hong Kong Time (HKT)</option>
      <option value="EST">North America Time (EST)</option>
      <option value="IST">India Time (IST)</option>
    </select>

    <!-- Custom Text -->
    <label for="custom-text">Custom Text:</label>
    <input type="text" id="custom-text" placeholder="Enter custom text...">

    <!-- Add to Timeline Button -->
    <button class="add-button" id="add-timeline-btn">Add to Timeline</button>

    <!-- Timeline TextBox -->
    <div class="timeline-box" id="timeline-box"></div>

    <!-- Buttons -->
    <div class="crud-container">
      <button class="delete-button" id="delete-timeline-btn">Delete Timeline</button>
      <button class="copy-button" id="copy-timeline-btn">Copy to Clipboard</button>
      <button class="save-button" id="save-timeline-btn">Save to TXT File</button>
    </div>
  </div>

  <script>
    // Mock data for Canned Text by Activity Type
    const cannedTexts = {
      "AKS Upgrade": [
        "Pre-check in Azure portal",
        "Logged into the cluster aks-xxx-xxx-xxx and checked the version and cluster-info",
        "Checking PDB - nothing found",
        "Execute validate.sh before for aks-xxx-xxx-xxx",
        "Setting the parameters in Jenkins",
        "Pipeline started",
        "Pipeline failed",
        "Started re-run the pipeline",
        "AKS upgrade completed for aks-xxx-xxx-xxx",
        "Post-validation completed",
        "xx PDB with xx value, perform the back-up of pdb to yaml file",
        "Deleted the PDBs with 0 value",
        "Apply the deleted PDBs"
      ],
      "Istio Upgrade": [
        "Prevalidation check and download core configs and scripts",
        "Exported the work folder",
        "Pre-upgrade validation commands run",
        "Verify the env vars exported",
        "Scale down error pods",
        "Istio_canary_upgrade.sh executed",
        "Verified the control plane version in logs",
        "Verified all the pods are using new revision",
        "Webhook configuration started",
        "Namespace labeling started",
        "Namespace labeling completed/verification started",
        "Verification completed",
        "Istio upgrade clean-up script started",
        "Scale up error pods"
      ],
      "Config Server (RCS) Upgrade": [
        "Pre-checks done",
        "Started setting parameters to deploy cfg server (aks-xxx-xxx-xxx)",
        "Change start time",
        "Started setting parameters and running build for Release",
        "All build for release got completed",
        "Started setting parameters and running build for network",
        "All build for network got completed",
        "Post verification done",
        "Scaled down the old version",
        "Endpoints Testing Done",
        "Uninstall Old Version",
        "Post verification done"
      ],
      "HBT Upgrade": [
        "Pre_check",
        "Actual change start time",
        "Login to cluster",
        "Add artifactory repo",
        "Helm repo update",
        "Setting Parameter",
        "Set the respective values file",
        "Run upgrade to install hbt app release",
        "Run upgrade to install hbt app network",
        "Version verification",
        "Scaling down the old version",
        "Curl ping returns OK",
        "Clean up started",
        "Post verification after clean up completed",
        "Post check completed",
        "Change Completed"
      ],
      "Certificate Renewal Istio Ingress Gateway": [
        "Pre checks completed",
        "Backup existing certificate and delete the secret",
        "Re-create istio secret (ISTIO_TLS_SECRET) with the newly created cert",
        "Verify ingress pods are running",
        "Post Upgrade Verification",
        "Get the relevant secure ingress host & ports",
        "Port forward and test the connection",
        "Get rsf-hbt-app logs",
        "Unset the variable and perform curl on ext endpoint"
      ],
      "Certificate renewal for APIM": [
        "Pre-checks done",
        "Started uploading Certs to APIM instance in Azure Portal",
        "Saved the Uploaded Certs",
        "Certs Uploaded Successfully, Expiry Date Updated in Azure Portal",
        "Post check Done",
        "Jenkins pipeline started",
        "Pipeline completed",
        "Post Verification done in Yoda Portal"
      ]
    }

    // Cache DOM elements
    const activityTypeSelect = document.getElementById("activity-type");
    const cannedTextSelect = document.getElementById("canned-text");
    const timezoneSelect = document.getElementById("timezone");
    const customTextInput = document.getElementById("custom-text");
    const timelineBox = document.getElementById("timeline-box");
    const addTimelineBtn = document.getElementById("add-timeline-btn");
    const deleteTimelineBtn = document.getElementById("delete-timeline-btn");
    const copyTimelineBtn = document.getElementById("copy-timeline-btn");
    const saveTimelineBtn = document.getElementById("save-timeline-btn");

    // Set initial canned text options based on the default activity type
    function updateCannedTextOptions() {
      const activityType = activityTypeSelect.value;
      cannedTextSelect.innerHTML = '<option value="">-- Select Canned Text --</option>'; // Clear previous options and add placeholder

      // Load canned texts based on the activity type
      if (cannedTexts[activityType]) {
        cannedTexts[activityType].forEach((text) => {
          const option = document.createElement("option");
          option.value = text;
          option.textContent = text;
          cannedTextSelect.appendChild(option);
        });
      }
    }

    // Timezone conversion function
    function getCurrentTimeInTimezone(timezone) {
      const now = new Date();
      const options = {
        hour: '2-digit',
        minute: '2-digit',
        hour12: true,
        timeZone: ''
      };

      switch (timezone) {
        case "HKT":
          options.timeZone = 'Asia/Hong_Kong';
          break;
        case "EST":
          options.timeZone = 'America/New_York';
          break;
        case "IST":
          options.timeZone = 'Asia/Kolkata';
          break;
      }

      return new Intl.DateTimeFormat('en-US', options).format(now);
    }

    // Format Date for Timeline Header
    function formatTimelineDate() {
      const options = { year: 'numeric', month: 'long', day: 'numeric' };
      return new Date().toLocaleDateString('en-US', options);
    }

    // Format Timeline Header
    function formatTimelineHeader(date) {
      const activityType = activityTypeSelect.value;
      return `Timeline ${date}<br>For aks-xxx-xxx-xxx ${activityType}`;
    }

    // Retrieve timeline from localStorage
    function loadTimelineFromStorage() {
      const storedTimeline = JSON.parse(localStorage.getItem("timeline"));
      if (storedTimeline && Array.isArray(storedTimeline)) {
        timelineBox.innerHTML = '';
        let currentDate = '';
        storedTimeline.forEach(item => {
          // Add new date header if the date changes
          if (!currentDate) {
            currentDate = item.date;
            timelineBox.innerHTML += `<h3>${formatTimelineHeader(currentDate)}</h3>`;
          }
          timelineBox.innerHTML += `<p>${item.entry}</p>`;
        });
      }
    }

    // Add entry to the timeline
    addTimelineBtn.addEventListener("click", () => {
      const cannedText = cannedTextSelect.value;
      const customText = customTextInput.value;

      // Validate that either canned text or custom text is selected, not both
      if (!cannedText && !customText) {
        alert("Please select a canned text option or enter custom text.");
        return;
      }

      if (cannedText && customText) {
        alert("You can only select either Canned Text or Custom Text, not both.");
        return;
      }

      const timezone = timezoneSelect.value;
      const currentTime = getCurrentTimeInTimezone(timezone);
      const entry = `${currentTime} ${cannedText}${customText ? `  ${customText}` : ''}`;

      // Save the entry to localStorage with today's date and time
      const storedTimeline = JSON.parse(localStorage.getItem("timeline")) || [];
      const today = formatTimelineDate();

      // Add timeline header if it's the first entry
      if (storedTimeline.length === 0) {
        timelineBox.innerHTML += `<h3>Timeline ${today}<br>For aks-xxx-xxx-xxx ${activityTypeSelect.value}</h3>`;
      } else if (!timelineBox.querySelector('h3')) {
        timelineBox.innerHTML += `<h3>Timeline ${today}<br>For aks-xxx-xxx-xxx ${activityTypeSelect.value}</h3>`;
      }

      storedTimeline.push({ date: today, entry });

      localStorage.setItem("timeline", JSON.stringify(storedTimeline));
      loadTimelineFromStorage();

      // Clear inputs after adding
      cannedTextSelect.value = '';
      customTextInput.value = '';
    });

    // Delete Timeline (Real-time)
    deleteTimelineBtn.addEventListener("click", () => {
      if (confirm("Are you sure you want to delete the timeline?")) {
        // Clear the content in the Timeline Textbox
        timelineBox.innerHTML = '';

        // Remove the timeline from localStorage
        localStorage.removeItem("timeline");
      }
    });

    // Copy Timeline to Clipboard
    copyTimelineBtn.addEventListener("click", () => {
      const timelineText = timelineBox.innerText;
      if (timelineText) {
        navigator.clipboard.writeText(timelineText).then(() => {
          alert("Timeline copied to clipboard!");
        });
      } else {
        alert("No timeline content to copy.");
      }
    });

    // Save Timeline to File (Simulate saving)
    saveTimelineBtn.addEventListener("click", () => {
      const timelineText = timelineBox.innerText;
      if (timelineText) {
        const blob = new Blob([timelineText], { type: "text/plain" });
        const link = document.createElement("a");
        link.href = URL.createObjectURL(blob);
        link.download = "timeline.txt";
        link.click();
      } else {
        alert("No timeline content to save.");
      }
    });

    // Update Canned Text options whenever the Activity Type changes
    activityTypeSelect.addEventListener("change", updateCannedTextOptions);

    // Initialize the app with default values
    updateCannedTextOptions();
    loadTimelineFromStorage();
  </script>
</body>
</html>